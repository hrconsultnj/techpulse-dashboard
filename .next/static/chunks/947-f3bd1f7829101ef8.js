"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[947],{4947:(e,r,t)=>{t.d(r,{A:()=>d});var a=t(2115),o=t(5647);let l="https://fcqejcrxtrqdxybgyueu.supabase.co",n="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZjcWVqY3J4dHJxZHh5Ymd5dWV1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM5NjE5NDgsImV4cCI6MjA1OTUzNzk0OH0.4_0zjIvreUrDE-wFNoHY62aMw9w-spf0mEdPyarxerM";if(!l||!n)throw Error("Missing Supabase environment variables. Check your .env.local file.");let s=(0,o.UU)(l,n),i={async getAll(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},t=s.from(e).select(r.columns||"*");r.filters&&r.filters.forEach(e=>{t=t.filter(e.column,e.operator,e.value)}),r.order&&(t=t.order(r.order.column,{ascending:r.order.ascending})),r.limit&&(t=t.limit(r.limit)),r.offset&&(t=t.range(r.offset,r.offset+(r.limit||10)-1));let{data:a,error:o}=await t;if(o)throw console.error("Error fetching from ".concat(e,":"),o),o;return a||[]},async getById(e,r,t){let{data:a,error:o}=await s.from(e).select(t||"*").eq("id",r).single();if(o){if("PGRST116"===o.code)return null;throw console.error("Error fetching ".concat(e," by ID:"),o),o}return a},async create(e,r){let{data:t,error:a}=await s.from(e).insert([r]).select().single();if(a)throw console.error("Error creating ".concat(e,":"),a),a;return t},async update(e,r,t){let{data:a,error:o}=await s.from(e).update(t).eq("id",r).select().single();if(o)throw console.error("Error updating ".concat(e,":"),o),o;return a},async delete(e,r){let{error:t}=await s.from(e).delete().eq("id",r);if(t)throw console.error("Error deleting from ".concat(e,":"),t),t},async search(e,r){let t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:["*"],a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:10,o=t.filter(e=>"*"!==e).map(e=>"".concat(e,".ilike.%").concat(r,"%")).join(","),l=s.from(e).select("*").or(o).limit(a),{data:n,error:i}=await l;if(i)throw console.error("Error searching ".concat(e,":"),i),i;return n||[]}};class c{async sendWebhook(e){let r=await fetch(this.baseUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!r.ok)throw Error("Webhook failed: ".concat(r.status," ").concat(r.statusText));return r.json()}async triggerUserSignup(e){let r={type:"user_signup",data:e,timestamp:new Date().toISOString(),source:"techpulse-dashboard"};try{await this.sendWebhook(r),console.log("User signup webhook triggered successfully")}catch(e){throw console.error("Failed to trigger user signup webhook:",e),e}}async triggerMarketingEmail(e){let r={type:"marketing_email",data:e,timestamp:new Date().toISOString(),source:"techpulse-dashboard"};try{await this.sendWebhook(r),console.log("Marketing email webhook triggered successfully")}catch(e){throw console.error("Failed to trigger marketing email webhook:",e),e}}async triggerCRMContact(e){let r={type:"crm_contact",data:e,timestamp:new Date().toISOString(),source:"techpulse-dashboard"};try{await this.sendWebhook(r),console.log("CRM contact webhook triggered successfully")}catch(e){throw console.error("Failed to trigger CRM contact webhook:",e),e}}constructor(){this.baseUrl="/api/webhook-proxy"}}let u=new c;function d(){var e,r,t,o;let[l,n]=(0,a.useState)({user:null,profile:null,loading:!0,error:null}),c=(0,a.useCallback)(e=>{n(r=>({...r,error:e,loading:!1}))},[]),d=(0,a.useCallback)(e=>{n(r=>({...r,loading:e}))},[]),m=(0,a.useCallback)(async e=>{try{return await i.getById("user_profiles",e)}catch(e){return console.error("Error fetching user profile:",e),null}},[]),f=(0,a.useCallback)(async e=>{try{d(!0),c(null);let{error:r}=await s.auth.signInWithPassword(e);if(r)throw r;return{error:null}}catch(r){let e=r instanceof Error?r.message:"Sign in failed";return c(e),{error:e}}},[c,d]),h=(0,a.useCallback)(async e=>{try{d(!0),c(null);let{email:r,password:t,...a}=e,{data:o,error:l}=await s.auth.signUp({email:r,password:t,options:{data:a}});if(l)throw l;if(o.user)try{await Promise.all([u.triggerUserSignup({userId:o.user.id,email:r,fullName:a.full_name,role:a.role||"customer",companyName:a.company_name,phone:a.phone,metadata:{signupDate:new Date().toISOString(),userAgent:navigator.userAgent,referrer:document.referrer}}),u.triggerMarketingEmail({email:r,fullName:a.full_name,tags:["new_user",a.role||"customer"],customFields:{companyName:a.company_name,phone:a.phone,signupDate:new Date().toISOString()}}),u.triggerCRMContact({email:r,fullName:a.full_name,companyName:a.company_name,phone:a.phone,leadSource:"techpulse_signup",properties:{role:a.role||"customer",signupDate:new Date().toISOString(),platform:"web"}})])}catch(e){console.error("Webhook automation failed:",e)}return{error:null}}catch(r){let e=r instanceof Error?r.message:"Sign up failed";return c(e),{error:e}}},[c,d]),g=(0,a.useCallback)(async()=>{try{d(!0),c(null);let{error:e}=await s.auth.signOut();if(e)throw e;return n({user:null,profile:null,loading:!1,error:null}),{error:null}}catch(r){let e=r instanceof Error?r.message:"Sign out failed";return c(e),{error:e}}},[c,d]),p=(0,a.useCallback)(async e=>{try{c(null);let{error:r}=await s.auth.resetPasswordForEmail(e.email,{redirectTo:"".concat(window.location.origin,"/reset-password")});if(r)throw r;return{error:null}}catch(r){let e=r instanceof Error?r.message:"Password reset failed";return c(e),{error:e}}},[c]),w=(0,a.useCallback)(async e=>{try{if(c(null),e.password!==e.confirmPassword)throw Error("Passwords do not match");let{error:r}=await s.auth.updateUser({password:e.password});if(r)throw r;return{error:null}}catch(r){let e=r instanceof Error?r.message:"Password update failed";return c(e),{error:e}}},[c]),y=(0,a.useCallback)(async e=>{try{if(!l.user)throw Error("No user logged in");d(!0),c(null);let{error:r}=await s.auth.updateUser({data:e});if(r)throw r;let t=await i.update("user_profiles",l.user.id,e);return n(e=>({...e,profile:t,loading:!1})),{error:null,data:t}}catch(r){let e=r instanceof Error?r.message:"Profile update failed";return c(e),{error:e}}},[l.user,c,d]),k=(0,a.useCallback)(async(e,r)=>{try{return await i.create("user_profiles",{id:e,email:r.email||"",full_name:r.full_name||null,role:r.role||"customer",company_name:r.company_name||null,phone:r.phone||null})}catch(e){return console.error("Error creating user profile:",e),null}},[]),b=(0,a.useCallback)(e=>{if(!l.profile)return!1;let r={customer:1,technician:2,supervisor:3,admin:4};return r[l.profile.role]>=r[e]},[l.profile]),_=(0,a.useCallback)(e=>{var r;return!!l.profile&&((null==(r=({customer:["own_tickets","chat"],technician:["own_tickets","assigned_tickets","chat","knowledge_base"],supervisor:["all_location_tickets","team_management","analytics","chat","knowledge_base"],admin:["all_tickets","user_management","system_settings","analytics","chat","knowledge_base"]})[l.profile.role])?void 0:r.includes(e))||!1)},[l.profile]);return(0,a.useEffect)(()=>{let e=!0;(async()=>{try{let{data:{session:r},error:t}=await s.auth.getSession();if(t)throw t;if((null==r?void 0:r.user)&&e){let e=await m(r.user.id);n({user:r.user,profile:e,loading:!1,error:null})}else e&&n(e=>({...e,loading:!1}))}catch(r){e&&c(r instanceof Error?r.message:"Session error")}})();let{data:{subscription:r}}=s.auth.onAuthStateChange(async(r,t)=>{if(e)if(null==t?void 0:t.user){let e=await m(t.user.id),i=e;if(!e&&"SIGNED_IN"===r){var a,o,l,s;i=await k(t.user.id,{email:t.user.email,full_name:null==(a=t.user.user_metadata)?void 0:a.full_name,role:(null==(o=t.user.user_metadata)?void 0:o.role)||"customer",company_name:null==(l=t.user.user_metadata)?void 0:l.company_name,phone:null==(s=t.user.user_metadata)?void 0:s.phone})}n({user:t.user,profile:i,loading:!1,error:null})}else n({user:null,profile:null,loading:!1,error:null})});return()=>{e=!1,r.unsubscribe()}},[m,k,c]),{...l,signIn:f,signUp:h,signOut:g,resetPassword:p,updatePassword:w,updateProfile:y,hasRole:b,canAccess:_,isAuthenticated:!!l.user,isCustomer:(null==(e=l.profile)?void 0:e.role)==="customer",isTechnician:(null==(r=l.profile)?void 0:r.role)==="technician",isSupervisor:(null==(t=l.profile)?void 0:t.role)==="supervisor",isAdmin:(null==(o=l.profile)?void 0:o.role)==="admin"}}}}]);